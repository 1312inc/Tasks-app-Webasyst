{strip}

    {function counts_pair total=0 count=0 bg_color=null text_color=null}
        {if !$count}
            {$total}
        {elseif $count == $total}
            <span class="{if $bg_color == '#ff0000'}badge{/if}" style="background:{ifempty($bg_color, 'transparent')};color:{ifempty($text_color, '#999')}">{$count}</span>
        {else}
            <span class="badge custom-mr-4" style="background:{ifempty($bg_color, 'transparent')};color:{ifempty($text_color, '#999')}">{$count}</span>
            {$total}
        {/if}
    {/function}

    {function user_count user_id=null}{strip}
        {if $is_admin}
            {$user_count = ifset($team_counts[$user_id], $empty_user_count)}
            {counts_pair total=$user_count.total count=$user_count.count bg_color=$user_count.bg_color text_color=$user_count.text_color}
        {/if}
    {/strip}{/function}


{$empty_user_count = [
    count => 0,
    total => 0,
    text_color => '#999',
    bg_color => 'transparent'
]}

<div class="sidebar-body t-sidebar-block" id="t-sidebar">
    <div class="box custom-mt-4">
        <div class="state-with-inner-icon left width-100">
            <span class="icon"><i class="fas fa-search"></i></span>
            <input class="solid" id="t-search-input" type="search" placeholder="[`Search`]"{if !empty($search_value)} value="{$search_value|escape}"{/if}>
        </div>
        <!-- <input class="t-sidebar-search-submit js-search-submit" type="button" value=""> -->
    </div>
    <div class="box custom-mt-4">
        <a id="add-task-link" class="button align-center width-90" href="#/add/">
            <i class="fas fa-plus-circle"></i>
            <span>[`New task`]</span>
        </a>
    </div>



    <div class="bricks custom-mt-4">
        <a href="#/tasks/inbox/" class="brick selected">
            <span class="icon" style="color: var(--accent-color);"><i class="fas fa-inbox"></i></span>
            <span class="count">
                {$user_count = ifset($team_counts[$wa->user('id')], $empty_user_count)}
                {if $user_count.total == $user_count.count}
                    {$inbox_urgent_count = $user_count.count - $hidden_count}
                {else}
                    {$inbox_urgent_count = $user_count.count}
                {/if}
                {counts_pair total=$user_count.total-$hidden_count count=$inbox_urgent_count bg_color=$user_count.bg_color text_color=$user_count.text_color}
            </span>
            [`Inbox`]
        </a>
        <a href="#/tasks/outbox/" class="brick">
            <span class="icon"><i class="fas fa-paper-plane"></i></span>
            <span class="count">{$outbox_count}</span>
            [`Outbox`]
        </a>
    </div>

    <ul class="menu">
        {if $is_admin}
            <li>
                <a href="#/log/">
                    <i class="fas fa-bolt" style="color: gold;"></i>
                    <span>[`Updates`]</span>
                </a>
            </li>
            <li>
                <a href="#/kanban/">
                    <i class="fas fa-columns"></i>
                    <span>[`Kanban`]</span>
                </a>
            </li>
        {/if}
    </ul>

    <ul class="menu">



                    <li class="inbox-hidden small gray"{if !$hidden_count} style="display: none"{/if}>
                        <span class="count">{$hidden_count}</span>
                        <a href="#/tasks/hidden/">[`Hidden`]</a>
                    </li>

        <li>
            {* Fix color for favorites task with high priority (dont use red)*}
            {if !empty($favorites_counts) && isset($favorites_counts.name)}
                {if $favorites_counts.name == 'High'}
                    {$favorites_counts.text_color = '#999'}
                    {$favorites_counts.bg_color = 'transparent'}
                {/if}
            {/if}
            <a href="#/tasks/favorites/">
                <i class="fas fa-star"></i>
                <span>[`My favorites`]</span>
                <span class="count">{counts_pair total=$favorites_counts.total count=$favorites_counts.count bg_color=$favorites_counts.bg_color text_color=$favorites_counts.text_color}</span>
            </a>
        </li>
        <li>
            <a href="#/tasks/urgent/">
                <span class="count">{counts_pair total=$urgent_count count=$super_urgent_count bg_color='#ff0000' text_color='white'}</span>
                <i class="fas fa-exclamation"></i>
                <span>[`Urgent`]</span>
            </a>
        </li>

        <!-- plugin hook: 'backend_sidebar.top_li' -->
        {* @event backend_sidebar.%plugin_id%.top_li *}
        {if !empty($backend_sidebar)}{foreach $backend_sidebar as $_}{ifset($_.top_li)}{/foreach}{/if}

        {if $is_admin}
            <li>
                <a href="#/log/">
                    <i class="fas fa-bolt"></i>
                    <span>[`Logbook`]</span>
                </a>
            </li>
        {/if}

    </ul>

    {if $lists}
        <div class="t-view-list-wrapper block" id="t-view-list-wrapper">
            <h5 class="heading">
                <span>
                    <span class="caret"><i class="fas fa-caret-down"></i></span>
                    [`My lists`]
                </span>
            </h5>
            <ul class="menu t-view-list hide-when-collapsed">

                {foreach $lists as $_list}
                    <li data-id="{$_list.id}">
                        {$_params = [
                            "list_id={$_list.id}",
                            "hash={$_list.hash|escape}"
                        ]}
                        {if $_list.params != null}
                            {$_params[] = $_list.params|escape}
                        {/if}
                        {if $_list.order != null}
                            {$_params[] = "order="|cat:$_list.order|escape}
                        {/if}
                        {$_params_str = join('&', $_params)}

                        {$_href = "#/tasks/{$_params_str}/"}
                        <a title="{$_list.name|escape}" href="{$_href}">
                            <!-- <i class="icon16 {$_list.icon|default:'contact'|escape}"></i> -->
                            <i class="fas fa-bug {$_list.icon|default:'contact'|escape}"></i>
                            <span>{$_list.name|truncate:18:'...':true|escape}</span>
                            <span class="count">{$_list.count|default:0}</span>
                        </a>
                    </li>
                {/foreach}
            </ul>
        </div>
    {/if}

    {if $scopes || $is_admin}

        <h5 class="heading">
            <span>
                <span class="caret"><i class="fas fa-caret-down"></i></span>
                [`Scopes`]
            </span>
            {if $is_admin}
                <a class="add-scope count action" href="#/webasyst/tasks/#/settings/scope/add/"><i class="fas fa-plus-circle"></i></a>
            {/if}
        </h5>

        {if $scopes}
            <ul class="t-scopes menu hide-when-collapsed">
                {foreach $scopes as $scope}
                    <li class="t-scope {if !empty($scope.due_date) && $scope.due_date < date('Y-m-d')}child-red{/if}">
                        <a href="#/tasks/scope/{$scope.id}/"{if isset($scope.closed_percent)}class="t-scope-title"{/if}>
                            <span class="icon"><i class="fas fa-fire"></i>{$scope.project.icon_html}</span>
                            <span>
                                {$scope.name|escape}
                                <span class="hint" style="display: block;">
                                    {if !empty($scope.due_date)}
                                        {$scope.due_date|wa_datetime:"humandate"}
                                    {else}
                                        [`Date is not set.`]
                                    {/if}
                                </span>
                            </span>
                            <span class="count">{if isset($scope.closed_percent)}{$scope.closed_percent}%{/if}</span>
                        </a>
                        <span class="hint t-closed-percent"></span>
                    </li>
                {/foreach}
            </ul>
        {else}
            <div class="box align-center custom-my-16">
                <p class="hint">[`No active work scopes are defined.`]</p>
            </div>
        {/if}

    {/if}

    <!-- plugin hook: 'backend_sidebar.section' -->
    {* @event backend_sidebar.%plugin_id%.section *}
    {if !empty($backend_sidebar)}{foreach $backend_sidebar as $_}{ifset($_.section)}{/foreach}{/if}

    <div id="status-list-wrapper">
        <h5 class="heading">
            <span>
                <span class="caret"><i class="fas fa-caret-down"></i></span>
                [`Status`]
            </span>
        </h5>
        <ul class="menu">
            {foreach tasksHelper::getStatuses() as $s}
                <li>
                    <a href="#/tasks/status/{$s.id}/">
                        <span class="icon">{$s.icon_html}</span>
                        <span>{$s.name|escape}</span>
                        {if $status_counts}
                        <span class="count">{ifset($status_counts[$s.id], 0)}</span>{/if}
                    </a>
                </li>
            {/foreach}
            <li class="gray">
                <a href="#/tasks/unassigned/">
                    <i class="icon16 userpic-unassigned"></i>
                    <span>[`Unassigned`]</span>
                    <span class="count">{user_count user_id=''}</span>
                </a>
            </li>
        </ul>
    </div>

    <div class="team-list-wrapper" id="team-list-wrapper">
        <h5 class="heading">
            <span>
                <span class="caret"><i class="fas fa-caret-down"></i></span>
                [`Team`]
            </span>
        </h5>
        {$_users = tasksHelper::getTeam(null, true)}
        {if !empty($_users)}
            <ul class="menu hide-when-collapsed">
                {foreach $_users as $user}
                    <li>
                        {user_count user_id=$user.id}
                        <a href="#/tasks/assigned/{$user.id}/"><i class="icon16 userpic20" style="background-image: url({waContact::getPhotoUrl($user.id, $user.photo, 40, 40, 'person', 0)})"></i>{$user.name|escape}</a>
                    </li>
                {/foreach}
            </ul>
        {else}
            <div class="box align-center custom-my-12 hide-when-collapsed">
                <p class="hint">{sprintf(_w('Use <strong>app "%s"</strong> to provide access to Tasks app for your teammates.'), $team_app_name)}</p>
            </div>
        {/if}
    </div>

    {if $projects || $is_admin}
        <div class="projects-list-wrapper" id="projects-list-wrapper">
            <h5 class="heading">
                <span href="javascript:void(0);">
                    <span class="caret"><i class="fas fa-caret-down"></i></span>
                    [`Projects`]
                </span>
                {if $is_admin}
                    <a class="add-project count action" href="#/settings/project/add/"><i class="fas fa-plus-circle"></i></a>
                {/if}
            </h5>
            {if $projects}
                <ul class="menu hide-when-collapsed">
                    {foreach $projects as $project}
                        <li>
                            <a href="#/tasks/project/{$project.id}/">
                                <!-- {$project.icon_html} -->
                                <i class="fas fa-star"></i>
                                <span>{$project.name|escape}</span>
                                {if !empty($project.color) && ($project.color != "t-white")}
                                    <i class="icon10 no-overhanging color {$project.color}"></i>
                                {/if}
                                {if $project.count !== null}
                                    <span class="count">{counts_pair total=$project.total count=$project.count bg_color=$project.priority_count.bg_color text_color=$project.priority_count.text_color}</span>
                                {/if}
                            </a>
                        </li>
                    {/foreach}
                </ul>
            {else}
                <div class="box align-center custom-my-12 hide-when-collapsed">
                    <p class="hint">[`Create a project by clicking the green tiny icon above.`]</p>
                </div>
            {/if}
        </div>
    {/if}

    {if !empty($cloud)}
        {if count($cloud) > tasksTaskTagsModel::TAGS_MAX_COUNT}
            <div id="collapsible-tags-autocomplete" data-block="tags">
                <h5 id="t-tags-autocomplete" class="heading collapse-handler">
                    <span>
                        <span class="caret"><i class="fas fa-caret-down"></i></span>
                        [`Tags`]
                    </span>
                </h5>
                <div class="box t-tags-wrapper hide-when-collapsed">
                <input id="js-t-sidebar-tags-autocomplete" value="" data-default="" class="ui-autocomplete-input" autocomplete="off" role="textbox" aria-autocomplete="list" aria-haspopup="true"></div>

                <p class="hint">
                    {sprintf(_w('There are more than %u tags.'), tasksTaskTagsModel::TAGS_MAX_COUNT)}<br>
                    [`Start typing in the search field to find a tag.`]
                </p>
            </div>
        {else}
            <div id="collapsible-tags" data-block="tags">
                <h5 id="t-tags" class="heading collapse-handler">
                    <span>
                        <span class="caret"><i class="fas fa-caret-down"></i></span>
                        [`Tags`]
                    </span>
                </h5>
                <div class="box align-center t-tags-wrapper js-tags-wrapper hide-when-collapsed">
                    <ul class="chips tags small">
                        {foreach $cloud as $tag}
                            <li>
                                <a style="opacity: {$tag.opacity};" data-id="{$tag.id}" data-value="{$tag.name|escape}" href="#/tasks/tag/{$tag.name|escape}/"><i class="fas fa-hashtag"></i> {$tag.name|escape}</a>
                            </li>
                        {/foreach}
                    </ul>
                </div>
            </div>
        {/if}
    {/if}

</div>

<div class="sidebar-footer shadowed">

    <ul class="menu">
        <li>
            <a href="#/personal-settings/">
                <span class="icon"><span class="userpic" style="background-image: url('{$wa->user()->getPhoto(20)}');"></span></span>
                <span>[`My preferences`]</span>
            </a>
        </li>
        {if $is_admin}
            <li>
                <a href="#/settings/">
                    <i class="fas fa-sliders-h"></i>
                    <span>[`Settings`]</span>
                </a>
            </li>
            <li>
                <a href="#/plugins/">
                    <i class="fas fa-plug"></i>
                    <span>[s`Plugins`]</span>
                </a>
            </li>
        {/if}

        <!-- plugin hook: 'backend_sidebar.bottom_li' -->
        {* @event backend_sidebar.%plugin_id%.bottom_li *}
        {if !empty($backend_sidebar)}{foreach $backend_sidebar as $_}{ifset($_.bottom_li)}{/foreach}{/if}

    </ul>

</div>

{/strip}
<script>
    (function ($) {

        new TasksSidebar({
            $wrapper: $(".t-sidebar-block")
        });

    })(jQuery);
</script>
